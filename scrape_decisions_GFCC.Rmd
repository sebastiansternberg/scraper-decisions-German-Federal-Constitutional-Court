---
title: "Untitled"
author: "Arnold, Neunhoeffer, Sternberg"
date: "6 8 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
rm(list = ls())
library(rvest)
library(magrittr)
library(stringr)
require(dplyr)

```

This should take around 45 minutes to finish. 

```{r}

pages <- c(1:721) # there are 721 pages to scrape

# getting the links to the decisions
links <- c()
for (i in 1:length(pages)){
  message("Getting decision ", i)
  html <- read_html(paste("https://www.bundesverfassungsgericht.de/SiteGlobals/Forms/Suche/Entscheidungensuche_Formular.html?gtp=5403124_list%253D",i,"&language_=de", sep = ""))
  href <- html %>% html_nodes(".relevance100+a") %>% html_attr("href")
  links <- c(links, href)
  message("taking a break of 3 seconds")
  Sys.sleep(3)
}

links

save(links, file = "links_decisons.Rda")
```



```{r}

# select the decisions' links
decisions <- links[grep("^SharedDocs/Entscheidungen/",links)] %>% strsplit(";") %>% sapply("[", 1)

# the links must look like this: https://www.bundesverfassungsgericht.de/SharedDocs/Entscheidungen/DE/2019/07/rs20190730_2bvr168514.html

#generate the correct link be adding the necessary prefix to it:

decisions <- gsub("SharedDocs/", "https://www.bundesverfassungsgericht.de/SharedDocs/", decisions)

```


```{r}


# Testing for one text
case <- read_html("https://www.bundesverfassungsgericht.de/SharedDocs/Entscheidungen/DE/2019/05/qk20190524_1bvq004619.html")

header <- case %>% html_nodes("#navBreadcrumbs strong") %>% html_text()
cite <- case %>% html_nodes(".cite") %>% html_text()
chamber_senate <- case %>% html_nodes(".rr1") %>% html_text()

judge1 <- case %>% html_nodes(".absatz:nth-child(8) span") %>% html_text()
judge2 <- case %>% html_nodes(".absatz:nth-child(9) span") %>% html_text()
judge3 <- case %>% html_nodes(".absatz:nth-child(10) span") %>% html_text()

link_decision <- case %>% html_nodes(".cite a") %>% html_text()

aktenzeichen <- case %>% html_nodes(".az2 span") %>% html_text()


```

Looping over all decision links:


#http://www.residualthoughts.com/2018/03/28/topic-analysis-of-tim-ferris-podcast-using-rvest/


For the first 1159 decisions:

```{r}

df_list <- list()

for(i in 1:1159){
  
  message("Scraping decision ", i)
  
case <- read_html(decisions[i])

header <- case %>% html_nodes("#navBreadcrumbs strong") %>% html_text()
cite <- case %>% html_nodes(".cite") %>% html_text()
chamber_senate <- case %>% html_nodes(".rr1") %>% html_text() %>% str_c(collapse = " ")

judges_names <- case %>% html_nodes(".rr2 span") %>% html_text()
judge1 <- judges_names[1]
judge2 <- judges_names[2]
judge3 <- judges_names[3]

judges_names <- str_c(judges_names, collapse = " ")

link_decision <- case %>% html_nodes(".cite a") %>% html_text()

#do not extract the aktenzeichen; this can be done via the header later; the reason is that the AZ link is error prone if multiple of them are collected together
#aktenzeichen <- case %>% html_nodes(".az2 span") %>% html_text()
#aktenzeichen <- aktenzeichen[1] #extract only the first AZ; this is also the one shown in the link of a decision

df_list[[i]] <-   data.frame(header = header, cite = cite, chamber_senate = chamber_senate, 
                             judges_names = judges_names,
                             judge1 = judge1, judge2 = judge2, judge3 = judge3,
                             link_decision = link_decision)


message("Iteration ", i, " of ", length(decisions),  " successful.")
message("taking a break")
Sys.sleep(1.5)
  
}

df_1_1159  <- do.call("rbind", df_list)


#decision 1160 is problematic becaust it is a weired Verzögerungsbeschwerde and does not follow the normal structure.
#TO DO: fix it with trycatch error such that the loop continues

```

For the decisions 1161 to 1479
```{r}

list_1161_1479 <- list()

for(i in 1161:length(decisions)){
  
  message("Scraping decision ", i)
  
case <- read_html(decisions[i])

header <- case %>% html_nodes("#navBreadcrumbs strong") %>% html_text()
cite <- case %>% html_nodes(".cite") %>% html_text()
chamber_senate <- case %>% html_nodes(".rr1") %>% html_text() %>% str_c(collapse = " ")

judges_names <- case %>% html_nodes(".rr2 span") %>% html_text()
judge1 <- judges_names[1]
judge2 <- judges_names[2]
judge3 <- judges_names[3]

judges_names <- str_c(judges_names, collapse = " ")

link_decision <- case %>% html_nodes(".cite a") %>% html_text()

#do not extract the aktenzeichen; this can be done via the header later; the reason is that the AZ link is error prone if multiple of them are collected together
#aktenzeichen <- case %>% html_nodes(".az2 span") %>% html_text()
#aktenzeichen <- aktenzeichen[1] #extract only the first AZ; this is also the one shown in the link of a decision

list_1161_1479[[i]] <-   data.frame(header = header, cite = cite, chamber_senate = chamber_senate, 
                             judges_names = judges_names,
                             judge1 = judge1, judge2 = judge2, judge3 = judge3,
                             link_decision = link_decision)


message("Iteration ", i, " of ", length(decisions),  " successful.")
message("taking a break")
Sys.sleep(1.5)
  
}


df_1161_1479  <- do.call("rbind", list_1161_1479)


#decision 1479 is problematic becaust it is a weired Verzögerungsbeschwerde and does not follow the normal structure.
#TO DO: fix it with trycatch error such that the loop continues


```


```{r}


list_1481 <- list()


i <- 1491

for(i in 1481:1495){
  
  message("Scraping decision ", i)
  
  case <- read_html(decisions[i])
  
  header <- case %>% html_nodes("#navBreadcrumbs strong") %>% html_text()
  cite <- case %>% html_nodes(".cite") %>% html_text()
  chamber_senate <- case %>% html_nodes(".rr1") %>% html_text() %>% str_c(collapse = " ")
  
  #this is where the names are usually located in the html: 
  
  judges_names <- case %>% html_nodes(".rr2 span") %>% html_text()
  
  #for some decisions the names of the judges are at another place:
  if(length(judges_names) == 0){
    judges_names1 <- case %>% html_nodes(".rr2") %>% html_text() %>% strsplit("\n") %>% unlist()
    judge1 <- judges_names1[1]
    judge2 <- judges_names1[2]
    judge3 <- judges_names1[3]
    
  #if they are not on another place, use the original ones:  
  } else{
    
  judge1 <- judges_names[1]
  judge2 <- judges_names[2]
  judge3 <- judges_names[3]
  judges_names <- str_c(judges_names, collapse = " ")
  }
  
  judges_names <- str_c(judges_names1, collapse = " ")
  
  link_decision <- case %>% html_nodes(".cite a") %>% html_text()
  
  #do not extract the aktenzeichen; this can be done via the header later; the reason is that the AZ link is error prone if multiple of them are collected together
  #aktenzeichen <- case %>% html_nodes(".az2 span") %>% html_text()
  #aktenzeichen <- aktenzeichen[1] #extract only the first AZ; this is also the one shown in the link of a decision
  
  list_1481[[i]] <-   data.frame(header = header, cite = cite, chamber_senate = chamber_senate, 
                                 judges_names = judges_names,
                                 judge1 = judge1, judge2 = judge2, judge3 = judge3,
                                 link_decision = link_decision)
  
  
  message("Iteration ", i, " of ", length(decisions),  " successful.")
  message("taking a break")
  Sys.sleep(1.5)
  
}


df_1481  <- do.call("rbind", list_1481)

```


```{r}

df_all_decisions  <- do.call("rbind", df_list)

save(df_all_decisions, file = "df_all_decisions.Rda")


```


NOW GET ALL DECISIONS

```{r}

df_list <- list()

for(i in 1:length(decisions)){
  
  
  message("Scraping decision ", i)
  
case <- read_html(decisions[i])

header <- case %>% html_nodes("#navBreadcrumbs strong") %>% html_text()
cite <- case %>% html_nodes(".cite") %>% html_text()
chamber_senate <- case %>% html_nodes(".rr1") %>% html_text() %>% str_c(collapse = " ")

judges_names <- case %>% html_nodes(".rr2 span") %>% html_text()
judge1 <- judges_names[1]
judge2 <- judges_names[2]
judge3 <- judges_names[3]

judges_names <- str_c(judges_names, collapse = " ")

link_decision <- case %>% html_nodes(".cite a") %>% html_text()

#do not extract the aktenzeichen; this can be done via the header later; the reason is that the AZ link is error prone if multiple of them are collected together
#aktenzeichen <- case %>% html_nodes(".az2 span") %>% html_text()
#aktenzeichen <- aktenzeichen[1] #extract only the first AZ; this is also the one shown in the link of a decision

df_list[[i]] <-   data.frame(header = header, cite = cite, chamber_senate = chamber_senate, 
                             judges_names = judges_names,
                             judge1 = judge1, judge2 = judge2, judge3 = judge3,
                             link_decision = link_decision, aktenzeichen = aktenzeichen)


message("Iteration ", i, " of ", length(decisions),  " successful.")
message("taking a break")
Sys.sleep(1.5)
}

df_all_decisions  <- do.call("rbind", df_list)

save(df_all_decisions, file = "df_all_decisions.Rda")

```

## Data Cleaning

Clean the decisions. First drop the decisions with an "Urteil", because these are not Chamber decisions

```{r}
source("helper_functions.R")

#load the 

chamber_decisions <- df_all_decisions[!grepl("Urteil", df_all_decisions$header), ]


#some of the remaining ones are a "Beschluss", but also not a chamber decisions. Because we know that sometimes there is a mistake in the citings, we make double sure that we do not drop the wrong decisions by checking whether the word "Kammer" is in the header of the decision and the suggested citation:

chamber_decisions$check_if_chamber1 <- grepl("Kammer", chamber_decisions$cite)
chamber_decisions$check_if_chamber2 <- grepl("Kammer", as.character(chamber_decisions$chamber_senate))

#always true
chamber_decisions$check_if_chamber1 == chamber_decisions$check_if_chamber2

#only keep the decisions which are not chamber decisions

chamber_decisions <- chamber_decisions[chamber_decisions$check_if_chamber1 == TRUE, ]

#clean the aktenzeichen

chamber_decisions$az <- str_extract_all(chamber_decisions$header, "\\d \\w\\w\\w \\d+...") %>% unlist

chamber_decisions <- chamber_decisions %>% select(az, everything())

#create date

for(i in 1:nrow(chamber_decisions)){
  
tmp <-  strsplit(as.character(chamber_decisions$header[i]), " ") %>%  unlist()
chamber_decisions$date[i] <- str_c(tmp[3:5], collapse = " ")

}

chamber_decisions$date <- german_date_to_date(chamber_decisions$date)

#extract the senate the chamber decision was decided in

chamber_decisions$senat <- str_extract(chamber_decisions$az, "[0-9]+") 
chamber_decisions$senat_check <- ifelse(grepl("Ersten Senats", as.character(chamber_decisions$chamber_senate)), 1, 2)


#extract the chambers

chamber_decisions$kammer_cit <- str_extract(as.character(chamber_decisions$cite), "[0-9]+")
chamber_decisions$kammer_txt <- str_extract(as.character(chamber_decisions$chamber_senate), "[0-9]+") 

#check:
chamber_decisions$kammer_cit == chamber_decisions$kammer_txt
  

#extracting the judges names


for(i in 1:nrow(chamber_decisions)){
  
chamber_decisions$richter_txt[i] <- c(names_extract(chamber_decisions$judge1[i]), names_extract(chamber_decisions$judge2[i]),
                                   names_extract(chamber_decisions$judge3[i])) %>% 
                                 str_c(collapse = " ") %>%  
                                  gsub("\\s", ",", .) #to bring it in the form for later analyses

}

#Einstweilige Anordnung:

chamber_decisions$anordnung <- ifelse(grepl("BvQ", chamber_decisions$az), 1, 0)


```

Now we have all the information that we need for the chamber paper. We save the data set. Before, we drop irrelevant information. 

```{r}

chamber_decisions <- chamber_decisions %>% 
  select(az, date, senat, kammer_cit, kammer_txt, richter_txt, anordnung, link = link_decision)

save(chamber_decisions, file = "chamber_decision_cleaned.Rda")


```






